name: Node.js CD

# Trigger manually for now. Uncomment 'push' block to enable auto-deploy.
on:
  workflow_dispatch:
  # push:
  #   branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if CI passes (uncomment when linking workflows)
    # needs: [ci] 

    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: 22
        script: |
          # Navigate to project directory
          cd ~/app/api-neutra-v2 
          
          # Pull latest changes
          git pull origin main
          
          # Create/Update .env file (optional, if you manage secrets via GH)
          # echo "PORT=3000" > .env
          # echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          
          # Deploy with Docker Compose
          docker-compose -f docker-compose.prod.yml up -d --build --remove-orphans
          
          # Prune unused images to save space
          docker image prune -f