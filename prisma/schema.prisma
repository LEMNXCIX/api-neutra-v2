// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-Tenancy
enum TenantType {
  STORE
  BOOKING
  HYBRID
}

enum PlanType {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

model Plan {
  id          String   @id @default(uuid())
  name        String   @unique
  type        PlanType
  price       Float    @default(0)
  description String?
  maxUsers    Int? // null = unlimited
  maxProducts Int? // null = unlimited

  tenants Tenant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("plans")
}

model Feature {
  id          String  @id @default(uuid())
  key         String  @unique // ECOMMERCE, BOOKING, CUSTOM_DOMAIN, etc.
  name        String
  description String?
  category    String? // MODULE, INTEGRATION, CUSTOMIZATION

  tenantFeatures TenantFeature[]

  createdAt DateTime @default(now())

  @@map("features")
}

model TenantFeature {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  featureId String
  feature   Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  enabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, featureId])
  @@index([tenantId])
  @@map("tenant_features")
}

model AuditLog {
  id     String @id @default(uuid())
  action String // IMPERSONATE, TENANT_TOGGLE, FEATURE_CHANGE
  userId String // SuperAdmin who performed action

  targetType String? // TENANT, USER
  targetId   String?
  metadata   Json? // Additional context
  ipAddress  String?
  userAgent  String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@map("audit_logs")
}

model Tenant {
  id     String     @id @default(uuid())
  name   String
  slug   String     @unique // Used for subdomain identification
  type   TenantType @default(STORE)
  config Json? // Tenant-specific configuration (colors, logo, etc.)
  active Boolean    @default(true)

  // Subscription
  planId String?
  plan   Plan?   @relation(fields: [planId], references: [id])

  // Relations
  users          User[]
  products       Product[]
  categories     Category[]
  orders         Order[]
  banners        Banner[]
  slideshows     Slideshow[]
  coupons        Coupon[]
  tenantFeatures TenantFeature[]
  roles          Role[]
  permissions    Permission[]
  
  // Booking Module Relations
  services       Service[]       @relation("TenantServices")
  staff          Staff[]         @relation("TenantStaff")
  appointments   Appointment[]   @relation("TenantAppointments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([planId])
  @@map("tenants")
}

// RBAC Models
model Role {
  id          String  @id @default(uuid())
  name        String  @unique // "ADMIN", "MANAGER", "USER"
  description String?
  level       Int     @default(0) // For backward compatibility
  active      Boolean @default(true)

  // Multi-tenancy: NULL = Global role (SUPER_ADMIN), <uuid> = Tenant-specific
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  permissions RolePermission[]
  users       User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          String  @id @default(uuid())
  name        String  @unique // "users:read", "products:write"
  description String?
  active      Boolean @default(true)

  // Multi-tenancy: NULL = Global permission, <uuid> = Tenant-specific
  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  roles RolePermission[]

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

enum OrderStatus {
  PENDIENTE
  PAGADO
  ENVIADO
  ENTREGADO
}

model User {
  id         String  @id @default(uuid())
  name       String
  email      String  @unique
  password   String
  roleId     String
  role       Role    @relation(fields: [roleId], references: [id])
  profilePic String?
  active     Boolean @default(true)

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Provider IDs
  googleId   String?
  facebookId String?
  twitterId  String?
  githubId   String?

  // Relations
  products Product[]
  cart     Cart?
  orders   Order[]
  appointments Appointment[] @relation("UserAppointments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("users")
}

model Product {
  id          String  @id @default(uuid())
  name        String
  price       Float
  description String
  image       String?
  stock       Int     @default(0)
  active      Boolean @default(true)

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  cartItems  CartItem[]
  orderItems OrderItem[]
  categories Category[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("products")
}

enum CategoryType {
  PRODUCT
  SERVICE
}

model Category {
  id          String  @id @default(uuid())
  name        String  // Removed @unique to allow same name in different tenants/types
  description String?
  type        CategoryType @default(PRODUCT)
  active      Boolean @default(true)

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  products Product[]
  services Service[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name, type])
  @@index([tenantId])
  @@map("categories")
}

model Cart {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  items CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carts")
}

model CartItem {
  id     String @id @default(uuid())
  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  amount Int

  @@unique([cartId, productId]) // Ensure unique product per cart
  @@map("cart_items")
}

model Order {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  status         OrderStatus @default(PENDIENTE)
  trackingNumber String?

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Coupon relation
  couponId       String?
  coupon         Coupon? @relation("CouponOrders", fields: [couponId], references: [id])
  discountAmount Float   @default(0)

  // Order totals
  subtotal Float @default(0)
  total    Float @default(0)

  items OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("orders")
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  amount Int
  price  Float // Snapshot of price at time of order

  @@map("order_items")
}

model Slideshow {
  id     String  @id @default(uuid())
  title  String
  img    String
  desc   String?
  active Boolean @default(true)

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("slideshows")
}

// Banner Model
model Banner {
  id              String  @id @default(uuid())
  title           String
  subtitle        String?
  description     String?
  imageUrl        String?
  backgroundColor String? @default("#000000")
  textColor       String? @default("#FFFFFF")

  cta    String? // Call to action text
  ctaUrl String? // Call to action URL

  priority Int     @default(0) // Higher = shown first
  active   Boolean @default(true)

  startsAt DateTime
  endsAt   DateTime

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Analytics
  impressions Int @default(0)
  clicks      Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("banners")
}

// Coupon Type Enum
enum CouponType {
  PERCENT
  FIXED
}

// Coupon Model
model Coupon {
  id    String     @id @default(uuid())
  code  String     @unique
  type  CouponType
  value Float // Percentage (0-100) or fixed amount

  description String?

  minPurchaseAmount Float? // Minimum order total required
  maxDiscountAmount Float? // Max discount for percentage coupons

  usageLimit Int? // null = unlimited
  usageCount Int  @default(0)

  active    Boolean  @default(true)
  expiresAt DateTime

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Optional: Limit to specific products/categories
  applicableProducts   String[] // Array of product IDs
  applicableCategories String[] // Array of category IDs

  // Relations
  orders Order[] @relation("CouponOrders")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("coupons")
}

// ============================================
// BOOKING MODULE
// ============================================

enum AppointmentStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Service {
  id          String   @id @default(uuid())
  name        String
  description String?
  duration    Int // Duration in minutes
  price       Float
  
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  
  active      Boolean  @default(true)
  
  // Multi-tenancy
  tenantId    String
  tenant      Tenant @relation("TenantServices", fields: [tenantId], references: [id])
  
  // Relations
  appointments Appointment[]
  staffServices StaffService[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, active])
  @@map("services")
}

model Staff {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String?
  avatar      String?
  bio         String?
  active      Boolean  @default(true)
  
  // Working hours (JSON: {monday: {start: "09:00", end: "17:00"}, ...})
  workingHours Json?
  
  // Multi-tenancy
  tenantId    String
  tenant      Tenant @relation("TenantStaff", fields: [tenantId], references: [id])
  
  // Relations
  appointments Appointment[]
  staffServices StaffService[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, active])
  @@map("staff")
}

// Junction table for many-to-many Staff-Service
model StaffService {
  id        String  @id @default(uuid())
  
  staffId   String
  staff     Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  tenantId  String
  
  @@unique([staffId, serviceId])
  @@index([tenantId])
  @@map("staff_services")
}

model Appointment {
  id              String   @id @default(uuid())
  
  // Who is booking
  userId          String
  user            User     @relation("UserAppointments", fields: [userId], references: [id])
  
  // What service
  serviceId       String
  service         Service  @relation(fields: [serviceId], references: [id])
  
  // With which staff member
  staffId         String
  staff           Staff    @relation(fields: [staffId], references: [id])
  
  // When
  startTime       DateTime
  endTime         DateTime
  
  // Status
  status          AppointmentStatus @default(PENDING)
  
  // Additional info
  notes           String?
  cancellationReason String?
  
  // Email tracking
  confirmationSent Boolean @default(false)
  reminderSent     Boolean @default(false)
  
  // Multi-tenancy
  tenantId        String
  tenant          Tenant   @relation("TenantAppointments", fields: [tenantId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, staffId, startTime])
  @@index([tenantId, status])
  @@map("appointments")
}
